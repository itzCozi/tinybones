---
import { getCollection } from "astro:content";
import BaseLayout from "@/layouts/BaseLayout.astro";
import SeoPage from "@/components/SeoPage.astro";
import Post from "@/components/Post.astro";

const posts = (await getCollection("blog")).filter((post) => !post.data.draft);
const seriesMap = new Map<string, typeof posts>();
for (const p of posts) {
  const slug = p.data.series;
  if (!slug) continue;
  const arr = seriesMap.get(slug) || [];
  arr.push(p);
  seriesMap.set(slug, arr);
}
const seriesList = Array.from(seriesMap.entries())
  .map(([slug, items]) => {
    const sorted = [...items].sort((a, b) => {
      const ai = a.data.seriesIndex || 0;
      const bi = b.data.seriesIndex || 0;
      if (ai !== bi) return ai - bi;
      return a.data.publicationDate.valueOf() - b.data.publicationDate.valueOf();
    });
    return { slug, items: sorted };
  })
  .sort((a, b) => a.slug.localeCompare(b.slug));
---

<BaseLayout>
  <SeoPage
    slot="head"
    title="Series"
    description="Browse post series"
  />
  <section>
    <h1 class="mb-4 text-2xl font-bold">Series</h1>
    {
      seriesList.length === 0 ?
        <p class="text-neutral-600 dark:text-neutral-300">No series yet.</p>
      : <ul class="flex list-none flex-wrap gap-2 p-0">
          {seriesList.map((s) => (
            <li>
              <a
                class="rounded-full border border-neutral-300 px-3 py-1.5 text-sm hover:bg-neutral-100 dark:border-neutral-700 dark:hover:bg-neutral-900"
                href={`/series/${encodeURIComponent(s.slug)}`}>
                {s.slug} <span class="opacity-60">({s.items.length})</span>
              </a>
            </li>
          ))}
        </ul>
    }
  </section>
</BaseLayout>
