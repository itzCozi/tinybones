---
import { type CollectionEntry, getCollection, render } from "astro:content";
import { Image } from "astro:assets";

import BaseLayout from "@/layouts/BaseLayout.astro";

import SeoPost from "@/components/SeoPost.astro";
import TableOfContents from "@/components/TableOfContents.astro";
import ShareButtons from "@/components/ShareButtons.astro";
import Giscus from "@/components/Giscus.astro";

import { formatDate, calculateReadingTime, slugifyAuthor } from "@/lib/util";
import { SITE } from "@/siteConfig";

interface Props {
  entry: CollectionEntry<"blog">;
  prevEntry: CollectionEntry<"blog"> | null;
  nextEntry: CollectionEntry<"blog"> | null;
}

export async function getStaticPaths() {
  const blog = (await getCollection("blog")).filter((post) => !post.data.draft);

  const sorted = [...blog].sort((a, b) => {
    const aDate = a.data.publicationDate ? new Date(a.data.publicationDate) : new Date(0);
    const bDate = b.data.publicationDate ? new Date(b.data.publicationDate) : new Date(0);
    return bDate.getTime() - aDate.getTime();
  });

  return sorted.map((entry, index) => {
    const prevEntry = index > 0 ? sorted[index - 1] : null;
    const nextEntry = index < sorted.length - 1 ? sorted[index + 1] : null;

    return {
      params: { id: entry.id },
      props: { entry, prevEntry, nextEntry },
    };
  });
}

const { entry, prevEntry, nextEntry } = Astro.props as Props;
const { Content } = await render(entry);
const readingTime = calculateReadingTime(entry.body || "");
let seriesPosts: CollectionEntry<"blog">[] = [];
let seriesPrev: CollectionEntry<"blog"> | null = null;
let seriesNext: CollectionEntry<"blog"> | null = null;

if (entry.data.series) {
  seriesPosts = (await getCollection("blog"))
    .filter((p) => !p.data.draft && p.data.series === entry.data.series)
    .sort((a, b) => {
      const ai = a.data.seriesIndex || 0;
      const bi = b.data.seriesIndex || 0;
      if (ai !== bi) return ai - bi;
      return a.data.publicationDate.valueOf() - b.data.publicationDate.valueOf();
    });
  const idx = seriesPosts.findIndex((p) => p.id === entry.id);
  seriesPrev = idx > 0 ? seriesPosts[idx - 1] : null;
  seriesNext = idx < seriesPosts.length - 1 ? seriesPosts[idx + 1] : null;
}
---

<BaseLayout showMobileToc>
  <SeoPost
    slot="head"
    {entry}
  />
  <div class="blog-post-container">
    <div class="blog-header mb-6">
      {
        entry.data.image && (
          <Image
            src={entry.data.image}
            alt={entry.data.imageAlt || ""}
            class="mb-12 h-auto w-full"
            loading="eager"
            fetchpriority="high"
            draggable="false"
          />
        )
      }
      <h1 class="text-[36px] leading-snug font-bold text-balance">
        {entry.data.title}
      </h1>
      {
        entry.data.tags && entry.data.tags.length > 0 && (
          <nav
            class="mt-2 flex flex-wrap gap-2 sm:hidden"
            aria-label="Post tags">
            {entry.data.tags.map((tag) => (
              <a
                href={`/tags/${encodeURIComponent(tag)}`}
                title={tag}
                class="rounded-full border border-neutral-300 px-3 py-1 text-sm hover:bg-neutral-100 dark:border-neutral-700 dark:hover:bg-neutral-900">
                {tag}
              </a>
            ))}
          </nav>
        )
      }
      <div class="text-muted-text dark:text-dark-muted-text mt-2 flex items-center justify-between">
        <div class="flex flex-col sm:flex-row sm:items-center sm:gap-1.5">
          <span>{formatDate(entry.data.publicationDate)}</span>
          {
            entry.data.authors && entry.data.authors.length > 0 && (
              <>
                <span class="hidden text-sm sm:inline">â€¢</span>
                <span class="text-sm">
                  By{" "}
                  {entry.data.authors.map((a, idx) => (
                    <>
                      {idx > 0 && (idx === entry.data.authors!.length - 1 ? " and " : ", ")}
                      <a
                        href={`/authors/${slugifyAuthor(a)}`}
                        class="underlined"
                        title={a}>
                        {a}
                      </a>
                    </>
                  ))}
                </span>
              </>
            )
          }
        </div>
        <span class="hidden sm:inline">{readingTime}</span>
      </div>
      {
        entry.data.tags && entry.data.tags.length > 0 && (
          <nav
            class="mt-3 hidden flex-wrap gap-3 sm:flex"
            aria-label="Post tags">
            {entry.data.tags.map((tag) => (
              <a
                href={`/tags/${encodeURIComponent(tag)}`}
                title={tag}
                class="rounded-full border border-neutral-300 px-3 py-1 text-sm hover:bg-neutral-100 dark:border-neutral-700 dark:hover:bg-neutral-900">
                {tag}
              </a>
            ))}
          </nav>
        )
      }
    </div>

    <div class="blog-content-wrapper lg:grid lg:grid-cols-4 lg:gap-10">
      <aside class="hidden lg:col-span-1 lg:block">
        <TableOfContents content={entry.body || ""} />
      </aside>

      <article class="lg:col-span-3">
        <div
          class="prose mx-auto max-w-none lg:mx-0"
          id="blog-content">
          <Content />
        </div>

        {
          (prevEntry || nextEntry) && (
            <nav
              class="mt-4 flex flex-col gap-3 pt-6 text-sm sm:flex-row sm:justify-between sm:gap-8"
              aria-label="Post navigation">
              <div class="sm:w-1/2">
                {prevEntry && (
                  <a
                    href={`/blog/${prevEntry.id}`}
                    class="block rounded-lg border border-neutral-300 px-4 py-3 hover:bg-neutral-100 dark:border-neutral-700 dark:hover:bg-neutral-900/50">
                    <span class="text-xs tracking-wide text-neutral-500 uppercase dark:text-neutral-400">
                      Previous
                    </span>
                    <p class="mt-1 line-clamp-2 font-medium">{prevEntry.data.title}</p>
                  </a>
                )}
              </div>

              <div class="sm:w-1/2 sm:text-right">
                {nextEntry && (
                  <a
                    href={`/blog/${nextEntry.id}`}
                    class="block rounded-lg border border-neutral-300 px-4 py-3 hover:bg-neutral-100 dark:border-neutral-700 dark:hover:bg-neutral-900/50">
                    <span class="text-xs tracking-wide text-neutral-500 uppercase dark:text-neutral-400">
                      Next
                    </span>
                    <p class="mt-1 line-clamp-2 font-medium">{nextEntry.data.title}</p>
                  </a>
                )}
              </div>
            </nav>
          )
        }

        {
          entry.data.series && (
            <div class="mt-4 border-t border-neutral-300 pt-4 dark:border-neutral-600">
              <ol class="m-0 flex list-none flex-col gap-2 p-0">
                {seriesPosts.map((p) => (
                  <li class={`text-sm`}>
                    {p.data.seriesIndex && <span class="mr-1">Part {p.data.seriesIndex}:</span>}
                    {p.id === entry.id ?
                      <span class={`${p.id === entry.id ? "font-semibold" : ""}`}>
                        {p.data.title}
                      </span>
                    : <a
                        href={`/blog/${p.id}`}
                        class="underlined">
                        {p.data.title}
                      </a>
                    }
                  </li>
                ))}
              </ol>
              <div class="mt-1.5 text-xs">
                <a
                  href={`/series/${entry.data.series}`}
                  class="underlined">
                  View series page
                </a>
              </div>
            </div>
          )
        }

        <ShareButtons
          title={entry.data.title}
          url={`${SITE.href.replace(/\/$/, "")}/blog/${entry.id}`}
          description={entry.data.description}
        />

        {entry.data.comments !== false && <Giscus class="mt-12" />}
      </article>
    </div>
  </div>
</BaseLayout>

<script>
  function highlightSearchTerm() {
    const urlParams = new URLSearchParams(window.location.search);
    const searchTerm = urlParams.get("search");

    if (!searchTerm) return;

    const blogContent = document.getElementById("blog-content");
    if (!blogContent) return;

    const contentText = blogContent.textContent || "";
    const searchTermLower = searchTerm.toLowerCase();
    const contentContainsSearchTerm = contentText.toLowerCase().includes(searchTermLower);

    if (!contentContainsSearchTerm) return;

    function escapeRegExp(string: string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    }

    function highlightTextNode(textNode: Text, searchText: string) {
      const parent = textNode.parentNode;
      if (!parent) return;

      const text = textNode.textContent || "";
      const escapedSearchText = escapeRegExp(searchText);
      const regex = new RegExp(`(${escapedSearchText})`, "gi");

      if (regex.test(text)) {
        const highlightedHTML = text.replace(regex, '<mark class="search-highlight">$1</mark>');
        const tempDiv = document.createElement("div");
        tempDiv.innerHTML = highlightedHTML;

        const fragment = document.createDocumentFragment();
        while (tempDiv.firstChild) {
          fragment.appendChild(tempDiv.firstChild);
        }
        parent.replaceChild(fragment, textNode);
      }
    }

    function walkTextNodes(node: Node) {
      if (node.nodeType === Node.TEXT_NODE) {
        highlightTextNode(node as Text, searchTerm!);
      } else {
        if (
          node.nodeType === Node.ELEMENT_NODE &&
          (node as Element).classList?.contains("search-highlight")
        ) {
          return;
        }

        const children = Array.from(node.childNodes);
        children.forEach((child) => walkTextNodes(child));
      }
    }

    walkTextNodes(blogContent);

    setTimeout(() => {
      const firstHighlight = document.querySelector(".search-highlight");
      if (firstHighlight) {
        firstHighlight.scrollIntoView({
          behavior: "smooth",
          block: "center",
        });

        setTimeout(() => {
          document.dispatchEvent(new CustomEvent("search-highlighting-complete"));
        }, 200);
      }
    }, 100);
  }

  document.addEventListener("astro:page-load", highlightSearchTerm);

  if (document.readyState !== "loading") {
    highlightSearchTerm();
  }

  function showCopyToast(message = "Copied link to clipboard") {
    const toast = document.createElement("div");
    toast.textContent = message;
    toast.className =
      "fixed bottom-4 right-4 z-50 rounded-lg text-md normal-case border border-neutral-400 px-3 py-1 dark:border-neutral-600 bg-white/90 dark:bg-neutral-900/90 backdrop-blur pointer-events-none";

    toast.style.textTransform = "none";

    toast.style.opacity = "0";
    toast.style.transition = "opacity 150ms ease, transform 150ms ease";
    toast.style.transform = "translateY(4px)";

    document.body.appendChild(toast);
    requestAnimationFrame(() => {
      toast.style.opacity = "1";
      toast.style.transform = "translateY(0)";
    });

    setTimeout(() => {
      toast.style.opacity = "0";
      toast.style.transform = "translateY(4px)";
      setTimeout(() => toast.remove(), 180);
    }, 1600);
  }

  function initHashtagCopyToast() {
    const container = document.getElementById("blog-content");
    if (!container) return;

    const FLAG = "__hashtag-copy-bound__";
    if ((container as any)[FLAG]) return;
    (container as any)[FLAG] = true;

    container.addEventListener("click", (evt) => {
      const target = evt.target as HTMLElement | null;
      if (!target) return;
      const link = target.closest("a") as HTMLAnchorElement | null;
      if (!link) return;

      const rawHref = link.getAttribute("href") || "";
      const looksLikePermalinkAnchor =
        (link.textContent || "").trim() === "#" ||
        link.getAttribute("aria-hidden") === "true" ||
        link.classList.contains("anchor") ||
        link.hasAttribute("data-anchor");

      if (!rawHref.startsWith("#") || !looksLikePermalinkAnchor) return;

      try {
        const url = new URL(window.location.href);
        url.hash = rawHref.slice(1);
        const text = url.toString();

        if (navigator.clipboard && window.isSecureContext) {
          navigator.clipboard
            .writeText(text)
            .then(() => showCopyToast())
            .catch(() => {});
        } else {
          // Fallback without deprecated execCommand: prompt user to copy
          window.prompt("Copy link to clipboard:", text);
        }
      } catch {}
    });
  }

  document.addEventListener("astro:page-load", initHashtagCopyToast);
  if (document.readyState !== "loading") {
    initHashtagCopyToast();
  }
</script>
